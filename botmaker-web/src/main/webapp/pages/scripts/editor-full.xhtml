<?xml version="1.0" encoding="UTF-8"?>
<ui:composition xmlns="http://www.w3.org/1999/xhtml" xmlns:ui="http://java.sun.com/jsf/facelets" xmlns:h="http://java.sun.com/jsf/html" xmlns:f="http://java.sun.com/jsf/core"
	xmlns:rich="http://richfaces.org/rich" xmlns:a4j="http://richfaces.org/a4j" template="/WEB-INF/templates/default.xhtml">
	<ui:define name="content">

		<h2 class="pc95">Script Editor</h2>

		<rich:panel id="registryId" styleClass="frm-crud pc95">
			<h:panelGroup styleClass="frm-line" rendered="#{scriptAction.bot ne null}">
				<h:outputLabel value="Bot" />
				<h:outputText value="#{scriptAction.bot.name}" />
			</h:panelGroup>
			<h:panelGroup styleClass="frm-line" rendered="#{scriptAction.script.command ne null}">
				<h:outputLabel value="Command" />
				<h:outputText value="#{scriptAction.script.command.key}" />
			</h:panelGroup>
			<h:panelGroup styleClass="frm-line" rendered="#{scriptAction.script.question ne null}">
				<h:outputLabel value="Command" />
				<h:outputText value="#{scriptAction.script.question.command.key}" />
				<h:outputLabel value="Question" />
				<h:outputText value="#{scriptAction.script.question.instruction}" />
				<h:outputLabel value="Script Type" />
			</h:panelGroup>
			<h:panelGroup styleClass="frm-line" rendered="#{scriptAction.script.validator ne null}">
				<h:outputLabel value="Validator" />
				<h:outputText value="#{scriptAction.script.validator.name}" />
			</h:panelGroup>
			<h:panelGroup styleClass="frm-line" rendered="#{scriptAction.script.validator ne null}">
				<h:outputLabel value="Short description" />
				<h:outputText value="#{scriptAction.script.validator.shortDescription}" />
			</h:panelGroup>
			<h:panelGroup styleClass="frm-line" rendered="#{scriptAction.script.validator ne null}">
				<h:outputLabel value="Validator Type" />
				<h:outputText value="#{scriptAction.script.validator.validatorType.descriptor}" />
			</h:panelGroup>
			<h:panelGroup styleClass="frm-line2" rendered="#{(scriptAction.bot eq null) and (scriptAction.script.validator eq null)}">
				<h:outputLabel value="Script Name" />
				<h:panelGroup styleClass="txt">
					<h:inputText value="#{scriptAction.script.name}" maxlength="40" size="40" />
				</h:panelGroup>
				<h:outputLabel value="Short description" styleClass="txtop" />
				<h:panelGroup styleClass="txt">
					<h:inputTextarea value="#{scriptAction.script.description}" rows="1" styleClass="pc70" />
				</h:panelGroup>
			</h:panelGroup>
			<h:panelGroup styleClass="frm-line2">
				<h:outputLabel value="Language" />
				<h:panelGroup styleClass="txt">
					<h:selectOneMenu id="scriptTypeId" value="#{scriptAction.script.scriptType}">
						<f:selectItems value="#{auxAction.scriptTypeOpt}" var="stOpt" itemLabel="#{stOpt.descriptor}" itemValue="#{stOpt}" />
						<f:ajax event="change" execute="@this" />
					</h:selectOneMenu>
				</h:panelGroup>
				<h:outputLabel value="Parse Mode" />
				<h:panelGroup styleClass="txt">
					<h:selectOneMenu id="parseModeId" value="#{scriptAction.script.parseMode}">
						<f:selectItems value="#{auxAction.parseModeOpt}" var="pmOpt" itemValue="#{pmOpt}" />
						<f:ajax event="change" execute="@this" />
					</h:selectOneMenu>
				</h:panelGroup>
			</h:panelGroup>
			<h:panelGroup layout="block" styleClass="frm-line2" rendered="#{(scriptAction.bot eq null) and (scriptAction.script.validator eq null)}">
				<h:outputLabel value="Is Generic" />
				<h:panelGroup styleClass="txt">
					<h:selectBooleanCheckbox value="#{scriptAction.script.generic}">
						<f:ajax event="click" execute="@this" />
					</h:selectBooleanCheckbox>
				</h:panelGroup>
			</h:panelGroup>
			<h:panelGroup styleClass="frm-line2" rendered="#{not scriptAction.script.generic}">
				<h:outputLabel value="Generic Script" />
				<h:panelGroup styleClass="txt">
					<h:selectOneMenu id="includeGenericId" value="#{scriptAction.script.genericScript}" converter="#{entityConverter}">
						<f:selectItem itemLabel="None" itemValue="#{null}" />
						<f:selectItems value="#{scriptAction.scripts}" var="incGen" itemLabel="#{incGen.name}" itemValue="#{incGen}" />
					</h:selectOneMenu>
				</h:panelGroup>
			</h:panelGroup>
		</rich:panel>

		<rich:panel styleClass="frm-crud pc95">
			<h:panelGrid columns="3" columnClasses="pc20 txtop,pc60 txtop,pc20 txtop" styleClass="pc100">
				<h:panelGroup layout="block" styleClass="pc100 hg100pc">
					<h3 class="mrauto pc100">Available Context</h3>
					<h:dataTable id="contextVarsId" headerClass="tx9" var="ctx" value="#{scriptAction.contextVars}" styleClass="pc100">
						<h:column headerClass="tx11 pc10">
							<f:facet name="header">#</f:facet>
							<h:graphicImage value="/resources/img/icons/info.png" title="#{ctx.description}" styleClass="tip-left" />
						</h:column>
						<h:column headerClass="tx11 pc40">
							<f:facet name="header">Var Name</f:facet>
							<h:outputText value="#{ctx.name}" styleClass="tx9 green" />
						</h:column>
						<h:column headerClass="tx11 pc50">
							<f:facet name="header">Value</f:facet>
							<h:inputText value="#{ctx.value}" size="15" maxlength="120" />
						</h:column>
					</h:dataTable>
				</h:panelGroup>
				<h:panelGroup layout="block" styleClass="hg100pc">
					<h:panelGroup id="panelScriptControlsId" layout="block">
						<h3 class="mrauto fleft pc50">Script Editor</h3>
						<h:commandButton value="Back to Command" action="#{scriptAction.goBackCommand()}" rendered="#{scriptAction.script.command ne null}" styleClass="secondary" />
						<h:commandButton value="Back to Validator" action="#{scriptAction.goBackValidator()}" rendered="#{scriptAction.script.validator ne null}" styleClass="secondary" />
						<h:commandButton id="btScriptTestId" value="Test" actionListener="#{scriptAction.testScript()}" styleClass="secondary">
							<a4j:ajax execute="frm:registryId frm:contextVarsId frm:scriptCode" render="frm:outputHiddenId" onbeforesubmit="scriptCodeMirror.save()" oncomplete="treatConsoleOutput()" />
						</h:commandButton>
						<h:commandButton id="btScriptSaveId" value="Save" action="#{scriptAction.saveScript()}" styleClass="primary">
							<a4j:ajax execute="frm:registryId frm:scriptCode" render="frm:outputHiddenId" onbeforesubmit="scriptCodeMirror.save()" oncomplete="treatConsoleOutput()" />
						</h:commandButton>
					</h:panelGroup>
					<h:panelGroup layout="block" styleClass="frm-line">
						<h:inputTextarea id="scriptCode" value="#{scriptAction.script.code}" rows="16" />
					</h:panelGroup>
				</h:panelGroup>
				<h:panelGroup layout="block" styleClass="pc100 hg100pc">
					<h3 class="mrauto pc100">Output Console</h3>
					<h:panelGroup layout="block" id="consoleOutputId" styleClass="output-console" />
					<h:inputHidden id="outputHiddenId" value="#{scriptAction.debugContent}" />
				</h:panelGroup>
			</h:panelGrid>
		</rich:panel>

		<script type="text/javascript">
		var scriptCodeMirror = CodeMirror.fromTextArea(document.getElementById('frm:scriptCode'), {
			mode: "groovy",
		    theme: "#{userPreferenceAction.scriptingTheme.value}", 
		    lineNumbers: true, 
		    lineWrapping: true, 
		    indentWithTabs: true
		});

		function configureCodeMirror() {
			scriptCodeMirror.setSize('98%', 400);
			scriptCodeMirror.setOption('theme', '#{userPreferenceAction.scriptingTheme.value}');
			scriptCodeMirror.setOption('readOnly', false);
		}
		
		function treatConsoleOutput() {
			var treatedContent = '';
			if (document.getElementById('frm:parseModeId').value == 'MARKDOWN') {
				treatedContent = markdown.toHTML(document.getElementById('frm:outputHiddenId').value);
			} else {
				treatedContent = document.getElementById('frm:outputHiddenId').value;
			}
			document.getElementById('frm:consoleOutputId').innerHTML = treatedContent;
		}
		configureCodeMirror();
	</script>

	</ui:define>

</ui:composition>

